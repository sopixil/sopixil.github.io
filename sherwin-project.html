<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Colorant Tester</title>
  <style>
    :root {
      --scale: 2;
    }

    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
      font-size: calc(1em * var(--scale));
    }

    #home-btn {
      position: fixed;
      top: 10px;
      left: 10px;
      background-color: #b8860b;
      color: white;
      padding: calc(6px * var(--scale)) calc(12px * var(--scale));
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      z-index: 999;
      font-size: calc(0.75em * var(--scale));
    }

    #main-box {
      width: 200px;
      height: 200px;
      background-color: white;
      margin: 0 auto 20px;
      border: 2px solid #ccc;
    }

    #controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: calc(10px * var(--scale));
      margin-bottom: calc(20px * var(--scale));
    }

    #total-display {
      font-weight: bold;
      margin-bottom: calc(10px * var(--scale));
    }

    .swatch-wrapper {
      display: flex;
      justify-content: center;
      margin: 0 auto;
    }

    .swatch-container {
      display: grid;
      grid-template-columns: repeat(10, auto);
      gap: calc(10px * var(--scale));
    }

    .swatch {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: calc(70px * var(--scale));
      padding: calc(6px * var(--scale));
      background: #f4f4f4;
      border-radius: 6px;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
    }

    .swatch-name {
      font-size: calc(12px * var(--scale));
      margin-bottom: 4px;
      text-transform: capitalize;
      font-weight: bold;
    }

    .swatch-color {
      width: calc(40px * var(--scale));
      height: calc(60px * var(--scale));
      border: 1px solid #000;
      margin: calc(4px * var(--scale)) 0;
    }

    .count {
      font-size: calc(11px * var(--scale));
      margin: calc(2px * var(--scale)) 0;
    }

    .button-group {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: calc(2px * var(--scale));
    }

    button {
      font-size: calc(9px * var(--scale));
      padding: calc(3px * var(--scale));
      min-width: calc(28px * var(--scale));
      cursor: pointer;
    }

    select {
      font-size: calc(12px * var(--scale));
      padding: calc(3px * var(--scale));
    }

    @media (max-width: 48em), (pointer: coarse) {
      .swatch-container {
        grid-template-columns: repeat(5, auto);
      }
    }
  </style>
</head>
<body>
  <div class="main">
    <button onclick="goHome()" style="position:absolute;top:10px;left:10px;background:#b8860b;color:white;padding:5px;border:none;cursor:pointer">Go Back Home</button>

    <div class="controls">
      <label for="baseSelect"><strong>Base:</strong></label>
      <select id="baseSelect" onchange="changeBase()">
        <option value="10">Extra White</option>
        <option value="4">Deep</option>
        <option value="1">Ultradeep</option>
      </select>
      <button onclick="resetMix()">Reset</button>
    </div>

    <div id="closestColor">Closest Sherwin-Williams Match: --</div>
    <div id="colorDisplay" class="color-display"></div>
    <div>Total Added: <span id="total">0</span> oz</div>

    <div class="swatch-grid" id="swatchGrid"></div>
  </div>

  <script>
    const colors = {
      Red: "C42F2A",
      Blue: "426DA9",
      Green: "6DA56D",
      Yellow: "F5D547",
      White: "FFFFFF",
      Black: "000000",
      Maroon: "6E2E2A",
      Magenta: "C85A90",
      Umber: "6B4C3B",
      Gold: "C28840",
    };

    const state = {
      baseWhite: 10,
      colorants: {},
      fromPicker: false,
      baseColor: [255, 255, 255]
    };

    for (let color in colors) {
      state.colorants[color] = 0;
    }

    if (document.referrer.includes("camera-app.html")) {
      const pickedColor = localStorage.getItem("pickedColor");
      if (pickedColor) {
        state.fromPicker = true;
        state.baseColor = hexToRGB(pickedColor);
      }
    } else {
      state.baseColor = [255, 255, 255];
    }

    function hexToRGB(hex) {
      return [parseInt(hex.slice(0, 2), 16), parseInt(hex.slice(2, 4), 16), parseInt(hex.slice(4, 6), 16)];
    }

    function RGBToHex([r, g, b]) {
      return (
        "#" + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join("")
      ).toUpperCase();
    }

    function updateDisplay() {
      let total = state.baseWhite;
      const mix = [state.baseColor[0] * state.baseWhite, state.baseColor[1] * state.baseWhite, state.baseColor[2] * state.baseWhite];

      for (let color in state.colorants) {
        const val = state.colorants[color];
        total += val;
        const rgb = hexToRGB(colors[color]);
        mix[0] += rgb[0] * val;
        mix[1] += rgb[1] * val;
        mix[2] += rgb[2] * val;
      }

      const final = mix.map(x => Math.round(x / total));
      document.getElementById("colorDisplay").style.backgroundColor = RGBToHex(final);
      document.getElementById("total").textContent = (total - state.baseWhite).toFixed(2);
      matchClosest(final);
    }

    function createSwatches() {
      const grid = document.getElementById("swatchGrid");
      for (let color in colors) {
        const div = document.createElement("div");
        div.className = "swatch";

        const add = document.createElement("div");
        add.className = "buttons";
        [1, 1/32, 1/64, 1/128].forEach(val => {
          const btn = document.createElement("button");
          btn.textContent = val % 1 ? val.toFixed(3) : val + "oz";
          btn.onclick = () => {
            if (getTotal() + val <= 12) {
              state.colorants[color] += val;
              updateDisplay();
            }
          };
          add.appendChild(btn);
        });

        const label = document.createElement("div");
        label.textContent = color + ": " + state.colorants[color].toFixed(2);
        label.className = "swatch-color";
        label.style.backgroundColor = "#" + colors[color];
        label.style.color = "#000";

        const remove = document.createElement("div");
        remove.className = "buttons";
        [1, 1/32, 1/64, 1/128].forEach(val => {
          const btn = document.createElement("button");
          btn.textContent = val % 1 ? val.toFixed(3) : val + "oz";
          btn.onclick = () => {
            state.colorants[color] = Math.max(0, state.colorants[color] - val);
            updateDisplay();
          };
          remove.appendChild(btn);
        });

        div.appendChild(add);
        div.appendChild(label);
        div.appendChild(remove);
        grid.appendChild(div);
      }
    }

    function getTotal() {
      return Object.values(state.colorants).reduce((a, b) => a + b, 0);
    }

    function resetMix() {
      for (let color in state.colorants) {
        state.colorants[color] = 0;
      }
      state.baseWhite = 10;
      state.baseColor = [255, 255, 255];
      state.fromPicker = false;
      localStorage.removeItem("pickedColor");
      document.getElementById("baseSelect").value = "10";
      updateDisplay();
    }

    function changeBase() {
      const baseVal = parseFloat(document.getElementById("baseSelect").value);
      state.baseWhite = baseVal;
      updateDisplay();
    }

    function goHome() {
      window.location.href = "camera-app.html";
    }

    function matchClosest(targetRGB) {
      fetch("allsherwincolours.txt")
        .then(res => res.text())
        .then(text => {
          const matches = text.split(/SW\d{4}/g).slice(1);
          const swList = text.match(/SW\d{4}/g);
          let bestDiff = Infinity;
          let bestMatch = "--";

          matches.forEach((entry, i) => {
            const line = entry.trim();
            const hex = line.slice(-6);
            const rgb = hexToRGB(hex);
            const diff = Math.sqrt(
              Math.pow(rgb[0] - targetRGB[0], 2) +
              Math.pow(rgb[1] - targetRGB[1], 2) +
              Math.pow(rgb[2] - targetRGB[2], 2)
            );
            if (diff < bestDiff) {
              bestDiff = diff;
              bestMatch = swList[i] + " " + line.split(" ")[0];
            }
          });

          document.getElementById("closestColor").textContent = "Closest Sherwin-Williams Match: " + bestMatch;
        })
        .catch(() => {
          document.getElementById("closestColor").textContent = "Closest Sherwin-Williams Match: Error";
        });
    }

    createSwatches();
    updateDisplay();
  </script>
</body>
</html>
