<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Colorant Mixer</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #f0f0f0;
    }
    h1 {
      margin: 10px;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 1000px;
    }
    .swatch {
      background-color: white;
      border: 1px solid #ccc;
      margin: 5px;
      padding: 5px;
      text-align: center;
      flex: 1 0 9%;
      min-width: 80px;
    }
    .swatch-buttons {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .swatch-buttons button {
      font-size: 0.7em;
      padding: 2px;
    }
    #colorBox {
      width: 200px;
      height: 200px;
      margin: 20px;
      border: 2px solid #000;
    }
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      padding: 10px;
      background-color: #b8860b;
      color: white;
    }
    #closestColor {
      margin: 10px;
      font-weight: bold;
    }
    @media (max-width: 600px) {
      .swatch {
        flex: 1 0 40%;
      }
    }
  </style>
</head>
<body>
  <div id="header">
    <button style="background:#b8860b;color:white;padding:10px;font-weight:bold" onclick="window.location.href='index.html'">Go Back Home</button>
    <div>
      Base:
      <select id="baseSelect">
        <option value="1">Ultradeep</option>
        <option value="4">Deep</option>
        <option value="10" selected>Extra White</option>
      </select>
      <button onclick="resetMixer()">Reset</button>
    </div>
  </div>
  <div id="closestColor">Closest Sherwin-Williams Color: ...</div>
  <div>Total Added: <span id="totalAdded">0</span> oz</div>
  <div id="colorBox"></div>
  <div id="controls"></div>  <script>
    const MAX_ADDED = 12;
    const baseWhiteSelect = document.getElementById("baseSelect");
    const totalDisplay = document.getElementById("totalAdded");
    const colorBox = document.getElementById("colorBox");
    const closestColor = document.getElementById("closestColor");

    const colors = {
      Red: "#b52b1f",
      Blue: "#405e91",
      Green: "#007749",
      Yellow: "#fed900",
      White: "#ffffff",
      Black: "#232323",
      Maroon: "#6d2f3a",
      Magenta: "#c0428a",
      Umber: "#635147",
      Gold: "#b8860b"
    };

    const mixState = {};
    let baseWhite = 10;
    let baseColor = { r: 255, g: 255, b: 255 };
    let fromPicker = false;

    for (let c in colors) mixState[c] = 0;

    const controls = document.getElementById("controls");
    for (let color in colors) {
      const div = document.createElement("div");
      div.className = "swatch";
      div.innerHTML = `
        <div class="swatch-buttons">
          <button onclick="addColor('${color}', 1)">1oz</button>
          <button onclick="addColor('${color}', 1/32)">1/32</button>
          <button onclick="addColor('${color}', 1/64)">1/64</button>
          <button onclick="addColor('${color}', 1/128)">1/128</button>
        </div>
        <div style="background:${colors[color]};height:20px;margin:5px 0;"></div>
        <div id="amount-${color}">0</div>
        <div class="swatch-buttons">
          <button onclick="removeColor('${color}', 1)">1oz</button>
          <button onclick="removeColor('${color}', 1/32)">1/32</button>
          <button onclick="removeColor('${color}', 1/64)">1/64</button>
          <button onclick="removeColor('${color}', 1/128)">1/128</button>
        </div>`;
      controls.appendChild(div);
    }

    function rgbToHex(r, g, b) {
      return [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
    }

    function getMixColor() {
      let total = 0;
      let r = baseColor.r * baseWhite;
      let g = baseColor.g * baseWhite;
      let b = baseColor.b * baseWhite;
      total += baseWhite;
      for (let c in mixState) {
        let amt = mixState[c];
        total += amt;
        let hex = colors[c];
        let cr = parseInt(hex.substr(1,2),16);
        let cg = parseInt(hex.substr(3,2),16);
        let cb = parseInt(hex.substr(5,2),16);
        r += cr * amt;
        g += cg * amt;
        b += cb * amt;
      }
      if (total === 0) return "#ffffff";
      return "#" + rgbToHex(Math.round(r / total), Math.round(g / total), Math.round(b / total));
    }

    function updateDisplay() {
      let total = 0;
      for (let c in mixState) total += mixState[c];
      totalDisplay.textContent = total.toFixed(3);
      const hex = getMixColor();
      colorBox.style.backgroundColor = hex;
      findClosestSherwin(hex);
      for (let c in mixState) {
        document.getElementById(`amount-${c}`).textContent = mixState[c].toFixed(3);
      }
    }

    function addColor(c, amt) {
      let total = 0;
      for (let k in mixState) total += mixState[k];
      if (total + amt > MAX_ADDED) return;
      mixState[c] += amt;
      updateDisplay();
    }

    function removeColor(c, amt) {
      mixState[c] = Math.max(0, mixState[c] - amt);
      updateDisplay();
    }

    function resetMixer() {
      for (let c in mixState) mixState[c] = 0;
      baseWhite = parseFloat(baseWhiteSelect.value);
      baseColor = { r: 255, g: 255, b: 255 };
      fromPicker = false;
      localStorage.removeItem('pickedColor');
      updateDisplay();
    }

    async function findClosestSherwin(hex) {
      try {
        const res = await fetch("allsherwincolours.txt");
        const text = await res.text();
        const entries = text.split(/(SW\d{4})/).slice(1);

        let colorsList = [];
        for (let i = 0; i < entries.length; i += 2) {
          const swCode = entries[i];
          const rest = entries[i+1].trim();
          const match = rest.match(/([A-Z][a-z\s]+)\s+(\d{1,3})\s+(\d{1,3})\s+(\d{1,3})\s+([A-Fa-f0-9]{6})$/);
          if (!match) continue;
          const [, name, r, g, b, hexcode] = match;
          colorsList.push({ name: name.trim(), sw: swCode, r: +r, g: +g, b: +b });
        }

        const target = colorBox.style.backgroundColor.match(/\d+/g).map(Number);
        let closest = null, minDist = Infinity;
        for (let col of colorsList) {
          let dist = Math.sqrt((col.r - target[0]) ** 2 + (col.g - target[1]) ** 2 + (col.b - target[2]) ** 2);
          if (dist < minDist) {
            minDist = dist;
            closest = col;
          }
        }

        if (closest) closestColor.textContent = `Closest Sherwin-Williams Color: ${closest.sw} ${closest.name}`;
      } catch (e) {
        closestColor.textContent = "Closest Sherwin-Williams Color: Error";
      }
    }

    (function init() {
      const picked = localStorage.getItem('pickedColor');
      if (picked) {
        const rgb = picked.match(/\w\w/g).map(h => parseInt(h, 16));
        baseColor = { r: rgb[0], g: rgb[1], b: rgb[2] };
        fromPicker = true;
      }
      baseWhite = parseFloat(baseWhiteSelect.value);
      baseWhiteSelect.addEventListener("change", () => {
        baseWhite = parseFloat(baseWhiteSelect.value);
        updateDisplay();
      });
      updateDisplay();
    })();
  </script></body>
</html>
